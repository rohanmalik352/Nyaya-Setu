<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nyaya-Setu | Judicial Verification</title>
  <link rel="icon" type="image/png" href="./favicon-final.png" />
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="/js/app.js" defer></script>
</head>

<%- include('partials/navbar') %>
<body>
  <!-- Ambient & Stars -->
  <div class="ns-amb"
    style="background: radial-gradient(circle at 50% 50%, rgba(50, 210, 130, .08) 0%, transparent 60%);"></div>
  <div class="ns-stars" id="starsContainer"></div>

  <div class="ns-page">
    <header class="ns-hdr">
      <a href="/" class="ns-btn-sm"
        style="text-decoration: none; color: inherit; border-color: rgba(255,255,255,0.2);">‚Üê HOME</a>
      <div class="ns-logo-n" style="color: #34d399;">Judicial Chamber</div>
      <div style="width: 50px;"></div>
    </header>

    <div class="ns-db-out">
      <div class="ns-db-in ns-db-in--g">
        <div style="text-align: center; margin-bottom: 2rem;">
          <svg width="60" height="60" viewBox="0 0 32 32" fill="none">
            <circle cx="16" cy="16" r="14" stroke="#34d399" stroke-width="1.5" fill="rgba(50,210,130,0.1)" />
            <path d="M8 10 L5 18 H11 Z" fill="#34d399" opacity="0.8" />
            <path d="M24 10 L21 18 H27 Z" fill="#34d399" opacity="0.8" />
            <line x1="16" y1="6" x2="16" y2="24" stroke="#34d399" stroke-width="1.5" />
            <line x1="8" y1="10" x2="24" y2="10" stroke="#34d399" stroke-width="1.5" />
            <line x1="12" y1="24" x2="20" y2="24" stroke="#34d399" stroke-width="1.5" />
          </svg>
          <h2 class="ns-ct" style="color: #34d399; margin-top: 10px;">Evidentiary Integrity Check</h2>
        </div>

        <form action="/verify<%= (typeof preFetched !== 'undefined' && preFetched) ? '/' + preFetched._id : '' %>"
          method="POST" enctype="multipart/form-data">
          <input type="text" class="ns-fi ns-fi--g" name="caseId" id="caseIdInput" placeholder="Enter Case ID Reference"
            value="<%= (typeof preFetched !== 'undefined' && preFetched) ? preFetched.caseId : '' %>" <%=(typeof
            preFetched !=='undefined' && preFetched) ? 'readonly' : 'required' %>
          >

          <label class="ns-fw" style="border-color: rgba(50, 210, 130, .4);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
              <polyline points="14 2 14 8 20 8" />
            </svg>
            <span class="ns-fw-lb" style="color: #34d399;">Upload Original File</span>
            <span class="ns-fw-st" style="margin-left: auto;">No file selected</span>
            <input type="file" name="file" required>
          </label>

          <button type="submit" class="ns-sub ns-sub--g">Execute Verification</button>
        </form>

        <!-- RESULT SECTION -->
        <% if (result) { %>
          <div class="ns-stb <%= result.valid ? 'success' : 'error' %>" style="margin-top: 2rem;">
            <%= result.valid ? '‚úì INTEGRITY CONFIRMED: File Matches Database Record' : '‚ö† WARNING: TAMPER DETECTED' %>

              <div
                style="font-family: monospace; font-size: 0.75rem; margin-top: 10px; opacity: 0.8; text-align: left;">
                <div>üìÇ File Hash: <%= result.currentHash.substring(0,25) %>...</div>
                <% if(result.originalHash) { %>
                  <div>üóÑÔ∏è DB Hash: &nbsp;<%= result.originalHash.substring(0,25) %>...</div>
                  <% } %>
              </div>
          </div>

          <!-- BLOCKCHAIN STATUS -->
          <div id="blockchainStatus" class="ns-stb loading" style="display:none; margin-top: 1rem;"></div>

          <% if (!result.valid && preFetched) { %>
            <a href="/evidence/retrieve/<%= preFetched._id %>" class="ns-sub--gold" style="margin-top: 2rem;">
              üîí Fetch Original Evidence
            </a>
            <% } %>
          <% } %>

      </div>
    </div>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0x7C9069A677807e4D168e3a7c40bFbe790288Ad18";
    const ABI = [
      { "inputs": [{ "internalType": "string", "name": "_caseId", "type": "string" }], "name": "verifyEvidence", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }
    ];

    <% if (result) { %>
        const fileHash = "<%= result.currentHash %>";
      const caseId = "<%= (typeof preFetched !== 'undefined' && preFetched) ? preFetched.caseId : '' %>" || document.getElementById('caseIdInput').value;
      verifyOnChain(caseId, fileHash);
    <% } %>

      async function verifyOnChain(caseId, currentFileHash) {
        const box = document.getElementById('blockchainStatus');
        box.style.display = 'block';
        box.textContent = "üîó Connecting to Sepolia Blockchain for Ledger Verification...";

        if (!window.ethereum) {
          box.className = "ns-stb error";
          box.textContent = "‚ö† MetaMask required for Blockchain Verification.";
          return;
        }

        try {
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
          const onChainHash = await contract.verifyEvidence(caseId);

          if (!onChainHash || onChainHash === "") {
            box.className = "ns-stb error";
            box.textContent = "‚ùå No Blockchain Record Found for this Case.";
            return;
          }

          if (onChainHash === currentFileHash) {
            box.className = "ns-stb success";
            box.innerHTML = "üîí <strong>BLOCKCHAIN VERIFIED</strong><br>Matches Immutable Ledger.";
          } else {
            box.className = "ns-stb error";
            box.innerHTML = "üö® <strong>BLOCKCHAIN MISMATCH</strong><br>Ledger Hash Different from File!";
          }
        } catch (err) {
          console.error(err);
          box.className = "ns-stb error";
          box.textContent = "Blockchain Error: " + err.message;
        }
      }
  </script>
</body>
<%- include('partials/footer') %>

</html>