<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nyaya-Setu | Police Evidence Registration</title>
  <link rel="icon" type="image/png" href="./favicon-final.png" />
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="/js/app.js" defer></script>
</head>

<%- include('partials/navbar') %>
<body>
  <!-- Ambient & Stars -->
  <div class="ns-amb"
    style="background: radial-gradient(circle at 50% 50%, rgba(50, 210, 130, .08) 0%, transparent 60%);"></div>
  <div class="ns-stars" id="starsContainer"></div>

  <div class="ns-page">
    <header class="ns-hdr">
      <a href="/" class="ns-btn-sm"
        style="text-decoration: none; color: inherit; border-color: rgba(255,255,255,0.2);">‚Üê HOME</a>
      <div class="ns-logo-n" style="color: #22d3ee;">Police Dashboard</div>
      <div style="width: 50px;"></div>
    </header>

      <div class="ns-db-out">
        <div class="ns-db-in">
          <h2 class="ns-ct" style="margin-bottom: 2rem;">Upload Evidence</h2>

          <!-- WALLET CONNECT -->
          <button id="connectBtn" class="ns-sub" onclick="connectWallet()"
            style="background: #ea580c; margin-bottom: 2rem;">
            ü¶ä Connect MetaMask
          </button>

          <form id="uploadForm">
            <input type="text" class="ns-fi" name="caseId" placeholder="Case Reference Number (e.g., CAS-2026-001)"
              required>
            <input type="text" class="ns-fi" name="officerId" placeholder="Investigating Officer Badge ID" required>

            <label class="ns-fw">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
              </svg>
              <span class="ns-fw-lb" style="">Choose Evidence File...</span>
              <span class="ns-fw-st" style="margin-left: auto;">No file selected</span>
              <input type="file" name="file" required>
            </label>

            <button type="submit" id="submitBtn" class="ns-sub">Upload to IPFS & Blockchain</button>
          </form>

          <div id="statusBox" class="ns-stb"></div>
        </div>

        <div style="text-align: center; margin-top: 1rem;">
          <a href="/evidence" class="ns-link">View Evidence Repository</a>
        </div>
      </div>
    </div>

    <script>
      // --- Blockchain Logic (Maintained from original) ---
      let signer;
      let contract;

      // --- COPY PASTE YOUR CONTRACT DETAILS HERE ---
      const CONTRACT_ADDRESS = "0x7C9069A677807e4D168e3a7c40bFbe790288Ad18";
      const ABI = [
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "string",
              "name": "caseId",
              "type": "string"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "fileHash",
              "type": "string"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "officer",
              "type": "address"
            }
          ],
          "name": "EvidenceStored",
          "type": "event"
        },
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "_caseId",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "_fileHash",
              "type": "string"
            }
          ],
          "name": "storeEvidence",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "_caseId",
              "type": "string"
            }
          ],
          "name": "verifyEvidence",
          "outputs": [
            {
              "internalType": "string",
              "name": "",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        }
      ];

      async function connectWallet() {
        if (!window.ethereum) return alert("Please install MetaMask!");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const sepChainId = "0xaa36a7"; // Sepolia
        try {
          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: sepChainId }] });
        } catch (err) {
          if (err.code === 4902) alert("Please add Sepolia Network to MetaMask!");
          return;
        }
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const address = await signer.getAddress();

        const btn = document.getElementById("connectBtn");
        btn.innerHTML = "‚úÖ Connected: " + address.slice(0, 6) + "...";
        btn.style.background = "#059669"; // Success Green
        btn.style.cursor = "default";

        document.getElementById("submitBtn").disabled = false;
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      }

      document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById("submitBtn");
        const statusBox = document.getElementById("statusBox");

        submitBtn.style.display = 'none';
        statusBox.className = 'ns-stb loading';
        statusBox.textContent = "‚è≥ Uploading to IPFS & Server...";

        try {
          const formData = new FormData(e.target);
          const response = await fetch('/evidence/upload-api', { method: 'POST', body: formData });
          const data = await response.json();

          if (!data.success) throw new Error("Server Upload Failed");

          const { dbId, fileHash, caseId } = data;

          statusBox.textContent = "ü¶ä Please Confirm Transaction in MetaMask...";

          const tx = await contract.storeEvidence(caseId, fileHash);

          statusBox.textContent = "‚è≥ Mining Transaction... Please Wait.";
          await tx.wait();

          await fetch('/evidence/confirm-tx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dbId, txHash: tx.hash })
          });

          statusBox.className = 'ns-stb success';
          statusBox.innerHTML = "üéâ Evidence Secured!<br>Tx: " + tx.hash.slice(0, 10) + "...";

          setTimeout(() => { window.location.href = "/evidence"; }, 2000);

        } catch (err) {
          console.error(err);
          submitBtn.style.display = 'block';
          statusBox.className = 'ns-stb error';
          statusBox.textContent = "Error: " + err.message;
        }
      });
    </script>
    <%- include('partials/footer') %>